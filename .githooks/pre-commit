#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

cd "$(git rev-parse --show-toplevel)"

EXIT_CODE=0
FAILED_CHECKS=()

# Helper: run a command and capture its stdout/stderr. If it fails, print the
# captured output indented and set EXIT_CODE=1. Uses mktemp when available.
run_check() {
  local desc="$1"; shift
  local tmp
  if tmp=$(mktemp 2>/dev/null); then
    :
  else
    tmp="$(pwd)/.precommit_tmp.$$"
  fi

  if "$@" >"$tmp" 2>&1; then
    echo "✓ $desc OK"
    rm -f "$tmp"
    return 0
  else
    echo
    echo "✗ $desc failed. Output:"
    sed 's/^/    /' "$tmp" || true
    rm -f "$tmp"
    EXIT_CODE=1
    FAILED_CHECKS+=("$desc")
    return 1
  fi
}

# ====================
# Rust formatting check
# ====================
if ! command -v cargo >/dev/null 2>&1; then
  echo "warning: cargo not found in PATH; skipping cargo fmt."
else
  # If rustup available, prefer checking rustfmt; otherwise allow cargo fmt presence
  if command -v rustup >/dev/null 2>&1; then
    if ! rustup component list --installed 2>/dev/null | grep -q '^rustfmt'; then
      if ! command -v rustfmt >/dev/null 2>&1; then
        echo "warning: rustfmt not installed. Run: rustup component add rustfmt"
      fi
    fi
  fi

  if run_check "Rust format check (cargo fmt --all -- --check)" cargo fmt --all -- --check; then
    :
  else
    echo
    echo "Running cargo fmt --all to autoformat..."
    # Show formatting output if any, and keep a trace
    if run_check "Rust autoformat (cargo fmt --all)" cargo fmt --all; then
      echo "✗ Rust code formatted. Review and restage the affected files."
      echo "Changes (git status --porcelain):"
      git status --porcelain | sed 's/^/    /' || true
    else
      echo "✗ Rust autoformat failed (see output above)."
    fi
  fi
  
  # ====================
  # Rust clippy check
  # ====================
  # Run clippy for the workspace (all targets & features). Treat any warnings as errors.
  # If rustup is available, prompt user to install the clippy component if missing.
  if command -v rustup >/dev/null 2>&1; then
    if ! rustup component list --installed 2>/dev/null | grep -q '^clippy'; then
      if ! command -v cargo-clippy >/dev/null 2>&1 && ! command -v clippy-driver >/dev/null 2>&1; then
        echo "warning: clippy not installed. Run: rustup component add clippy"
      fi
    fi
  fi

  echo "Checking Rust lints with cargo clippy..."
  # Use -D warnings to ensure warnings become errors in CI/pre-commit.
  if ! run_check "cargo clippy --workspace --all-targets --all-features -- -D warnings" \
     cargo clippy --workspace --all-targets --all-features -- -D warnings; then
    echo
    echo "✗ Clippy failed. Run: cargo clippy --workspace --all-targets --all-features -- -D warnings"
  fi
fi

# ====================
# Python checks (if Python available and python/ directory exists)
# ====================
if [ -d "python" ]; then
  if command -v python >/dev/null 2>&1 || command -v python3 >/dev/null 2>&1; then
    PYTHON_CMD=$(command -v python3 2>/dev/null || command -v python 2>/dev/null)
    echo "Checking Python files..."

    # Check for ruff
    if command -v ruff >/dev/null 2>&1; then
      echo "Running ruff format..."
      if run_check "ruff format --check python/" ruff format --check python/; then
        :
      else
        echo
        echo "Running ruff format python/... to autoformat..."
        if run_check "ruff format python/" ruff format python/; then
          echo "✗ Python code formatted. Review and restage the affected files."
          echo "Changes (git status --porcelain):"
          git status --porcelain | sed 's/^/    /' || true
        else
          echo "✗ ruff format failed (see output above)."
        fi
      fi

      echo "Running ruff check..."
      if ! run_check "ruff check python/ --fix" ruff check python/ --fix; then
        echo "✗ ruff linting failed. Fix the issues above."
      fi
    else
      echo "warning: ruff not found. Install with: pip install ruff"
    fi

    # Check for mypy
    if command -v mypy >/dev/null 2>&1; then
      echo "Running mypy type check..."
      if ! run_check "mypy --strict --warn-unused-ignores python/" \
         mypy --strict --warn-unused-ignores python/; then
        echo "✗ mypy type check failed. Fix the type errors above."
      fi
    else
      echo "warning: mypy not found. Install with: pip install mypy"
    fi
  else
    echo "warning: Python not found; skipping Python checks"
  fi
fi

# ====================
# JavaScript checks (if Node.js available and package.json exists)
# ====================
if [ -f "package.json" ]; then
  if command -v node >/dev/null 2>&1; then
    echo "Checking JavaScript files..."

    # Check for syntax errors
    JS_FILES=$(find rust/web/static -name "*.js" -type f 2>/dev/null || true)
    if [ -n "$JS_FILES" ]; then
      SYNTAX_ERROR=0
      while IFS= read -r file; do
        if ! run_check "JavaScript syntax check: $file" node --check "$file"; then
          SYNTAX_ERROR=1
        fi
      done <<< "$JS_FILES"

      if [ $SYNTAX_ERROR -eq 0 ]; then
        echo "✓ JavaScript syntax OK"
      fi
    fi

    # Run ESLint if available
    if command -v npm >/dev/null 2>&1 && [ -f "node_modules/.bin/eslint" ]; then
      if ! run_check "npm run lint --silent" npm run lint --silent; then
        echo "✗ ESLint failed. Run: npm run lint"
      fi
    else
      echo "ℹ ESLint not installed. Run: npm install"
    fi
  else
    echo "warning: Node.js not found; skipping JavaScript checks"
  fi
fi

if [ $EXIT_CODE -ne 0 ]; then
  echo
  echo "Pre-commit checks failed. Summary of failed checks:"
  for f in "${FAILED_CHECKS[@]}"; do
    echo " - $f"
  done
  echo
  echo "Fix issues and try again."
  exit 1
fi

exit 0