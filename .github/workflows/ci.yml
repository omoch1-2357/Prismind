name: CI

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Fast-fail: Format check (runs first, fastest)
  fmt:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all --check

  # Fast-fail: Clippy lints (runs after fmt)
  clippy:
    name: Clippy Lints
    runs-on: ubuntu-latest
    needs: fmt
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache Cargo registry and build artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: clippy-cache

      - name: Run Clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  # Test on multiple platforms and Rust versions
  test:
    name: Test (${{ matrix.os }} - Rust ${{ matrix.rust }})
    runs-on: ${{ matrix.os }}
    needs: clippy
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable, beta]
        include:
          - os: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust ${{ matrix.rust }}
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: Cache Cargo registry and build artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: test-${{ matrix.os }}-${{ matrix.rust }}

      - name: Run tests
        run: cargo test --workspace --all-features --verbose

      - name: Run doc tests
        run: cargo test --doc --workspace --all-features --verbose

  # Benchmarks (runs on stable only)
  bench:
    name: Benchmarks
    runs-on: ubuntu-latest
    needs: clippy
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo registry and build artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: bench-cache

      - name: Run benchmarks (check only)
        run: cargo bench --workspace --no-fail-fast -- --test

      - name: Build benchmarks (verify compilation)
        run: cargo bench --workspace --no-run

  # Documentation build check
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    needs: clippy
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo registry and build artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: docs-cache

      - name: Build documentation
        run: cargo doc --workspace --all-features --no-deps --document-private-items
        env:
          RUSTDOCFLAGS: -D warnings

  # Release build verification
  build-release:
    name: Release Build
    runs-on: ubuntu-latest
    needs: [test, bench, docs]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo registry and build artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: release-cache

      - name: Build release binary
        run: cargo build --release --verbose

      - name: Verify binary size (should be optimized with LTO)
        run: |
          ls -lh target/release/prismind
          size target/release/prismind || file target/release/prismind

  # ARM64 cross-compilation check (validates ARM64 optimization settings)
  cross-compile-arm64:
    name: ARM64 Cross-Compilation Check
    runs-on: ubuntu-latest
    needs: clippy
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      - name: Install cross-compilation toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Cache Cargo registry and build artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: arm64-cache

      - name: Check ARM64 compilation
        run: cargo check --target aarch64-unknown-linux-gnu --release
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc

  # Final status check (all jobs must pass)
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [fmt, clippy, test, bench, docs, build-release, cross-compile-arm64]
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          if [ "${{ needs.fmt.result }}" != "success" ] || \
             [ "${{ needs.clippy.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.bench.result }}" != "success" ] || \
             [ "${{ needs.docs.result }}" != "success" ] || \
             [ "${{ needs.build-release.result }}" != "success" ] || \
             [ "${{ needs.cross-compile-arm64.result }}" != "success" ]; then
            echo "❌ One or more CI jobs failed"
            exit 1
          else
            echo "✅ All CI jobs passed successfully"
          fi
