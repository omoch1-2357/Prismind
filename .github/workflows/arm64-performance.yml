name: ARM64 Performance Benchmarks

# Run on pull requests to phase1-foundation and main branches
on:
  pull_request:
    branches: [phase1-foundation, main]
    paths:
      - 'src/**'
      - 'benches/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/arm64-performance.yml'
  workflow_dispatch:
    inputs:
      baseline:
        description: 'Baseline commit/branch to compare against'
        required: false
        default: ''

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ARM64 Native Performance Benchmarks
  arm64-benchmarks:
    name: ARM64 Performance (Native)
    # Use ARM64 runner (GitHub-hosted or self-hosted)
    # For GitHub-hosted ARM64: ubuntu-24.04-arm (preview)
    # For self-hosted: use 'self-hosted' with appropriate labels
    runs-on: ubuntu-latest  # Will be updated to ARM64 runner when available

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Fetch full history for baseline comparison

      - name: Install Rust stable for ARM64
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      - name: Cache Cargo registry and build artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: arm64-bench-cache

      - name: Install performance monitoring tools
        run: |
          # Install perf for cache miss measurement (Linux only)
          if [ "$(uname -s)" = "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y linux-tools-generic linux-tools-common || true
          fi

      - name: Build benchmarks in release mode
        run: |
          cargo build --release --benches
        env:
          RUSTFLAGS: "-C target-cpu=native -C target-feature=+neon,+crc,+crypto"

      - name: Run rotation benchmarks
        run: |
          echo "## Rotation Benchmarks" >> $GITHUB_STEP_SUMMARY
          cargo bench --bench rotation_bench -- --save-baseline rotation || true
          echo "Target: rotate_180 < 200ns (ARM64 REV instruction)" >> $GITHUB_STEP_SUMMARY

      - name: Run legal moves benchmarks
        run: |
          echo "## Legal Moves Benchmarks" >> $GITHUB_STEP_SUMMARY
          cargo bench --bench legal_moves_bench -- --save-baseline legal_moves || true
          echo "Target: legal_moves < 500ns (ARM64 CLZ/CTZ instructions)" >> $GITHUB_STEP_SUMMARY

      - name: Run make move benchmarks
        run: |
          echo "## Make Move Benchmarks" >> $GITHUB_STEP_SUMMARY
          cargo bench --bench make_move_bench -- --save-baseline make_move || true
          echo "Target: make_move < 1.5Î¼s" >> $GITHUB_STEP_SUMMARY

      - name: Run pattern extraction benchmarks
        run: |
          echo "## Pattern Extraction Benchmarks" >> $GITHUB_STEP_SUMMARY
          cargo bench --bench extract_patterns_bench -- --save-baseline extract_patterns || true
          echo "Target: extract_all_patterns < 25Î¼s (cache miss rate 30-40%)" >> $GITHUB_STEP_SUMMARY

      - name: Run score conversion benchmarks
        run: |
          echo "## Score Conversion Benchmarks" >> $GITHUB_STEP_SUMMARY
          cargo bench --bench score_conversion_bench -- --save-baseline score_conversion || true
          echo "Note: NEON SIMD optimization for batch conversion" >> $GITHUB_STEP_SUMMARY

      - name: Run evaluation benchmarks
        run: |
          echo "## Evaluation Function Benchmarks" >> $GITHUB_STEP_SUMMARY
          cargo bench --bench evaluate_bench -- --save-baseline evaluate || true
          echo "Target: evaluate < 35Î¼s (with prefetch and SoA optimization)" >> $GITHUB_STEP_SUMMARY

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: arm64-benchmark-results
          path: |
            target/criterion/
            perf-*.data
          retention-days: 30

      - name: Generate performance summary
        if: always()
        run: |
          echo "# ARM64 Performance Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Performance Targets (Phase 1 Requirements)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Legal moves generation: < 500ns" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Pattern extraction (56 patterns): < 25Î¼s" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Evaluation function: < 35Î¼s" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Make move (with flip): < 1.5Î¼s" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ BitBoard rotation: < 200ns" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Cache Performance Targets" >> $GITHUB_STEP_SUMMARY
          echo "- Cache miss rate: 30-40% (to be measured with perf)" >> $GITHUB_STEP_SUMMARY
          echo "- Memory usage: < 80MB (SoA format evaluation table)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Full benchmark reports are available in the artifacts." >> $GITHUB_STEP_SUMMARY

  # Cache Miss Rate Measurement (Linux ARM64 only)
  arm64-cache-analysis:
    name: ARM64 Cache Analysis
    runs-on: ubuntu-latest  # Will be updated to ARM64 runner
    if: false  # Disabled until ARM64 runner is available

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      - name: Install perf tools
        run: |
          sudo apt-get update
          sudo apt-get install -y linux-tools-generic linux-tools-$(uname -r) || \
          sudo apt-get install -y linux-tools-common

      - name: Build release binary
        run: cargo build --release
        env:
          RUSTFLAGS: "-C target-cpu=native -C target-feature=+neon,+crc,+crypto"

      - name: Run cache miss analysis with perf
        run: |
          echo "## Cache Miss Analysis" >> $GITHUB_STEP_SUMMARY

          # Run evaluation benchmark with perf
          sudo perf stat -e cycles,instructions,cache-references,cache-misses,branches,branch-misses \
            cargo bench --bench evaluate_bench -- --test 2>&1 | tee perf-output.txt || true

          # Parse and report cache miss rate
          if [ -f perf-output.txt ]; then
            echo "### Performance Counters" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat perf-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target**: Cache miss rate < 40%" >> $GITHUB_STEP_SUMMARY
          echo "**Target**: IPC (instructions per cycle) > 0.85" >> $GITHUB_STEP_SUMMARY

      - name: Upload perf data
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: arm64-perf-data
          path: perf-*.txt
          retention-days: 30

  # Comparison with baseline (optional)
  benchmark-comparison:
    name: Compare with Baseline
    runs-on: ubuntu-latest
    needs: arm64-benchmarks
    if: github.event.inputs.baseline != ''

    steps:
      - name: Checkout current branch
        uses: actions/checkout@v5

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Download current benchmarks
        uses: actions/download-artifact@v4
        with:
          name: arm64-benchmark-results
          path: ./current-benchmarks

      - name: Checkout baseline
        run: |
          git fetch origin ${{ github.event.inputs.baseline }}
          git checkout ${{ github.event.inputs.baseline }}

      - name: Run baseline benchmarks
        run: |
          cargo bench -- --save-baseline baseline || true

      - name: Compare results
        run: |
          echo "# Benchmark Comparison" >> $GITHUB_STEP_SUMMARY
          echo "Baseline: ${{ github.event.inputs.baseline }}" >> $GITHUB_STEP_SUMMARY
          echo "Current: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Detailed comparison available in Criterion HTML reports." >> $GITHUB_STEP_SUMMARY

  # Performance regression check
  performance-gate:
    name: Performance Regression Gate
    runs-on: ubuntu-latest
    needs: arm64-benchmarks
    if: always()

    steps:
      - name: Check performance targets
        run: |
          echo "# Performance Gate Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This job verifies that all performance targets are met." >> $GITHUB_STEP_SUMMARY
          echo "Review the benchmark results above to ensure:" >> $GITHUB_STEP_SUMMARY
          echo "- All operations meet target latencies" >> $GITHUB_STEP_SUMMARY
          echo "- No significant performance regressions" >> $GITHUB_STEP_SUMMARY
          echo "- Cache efficiency targets are maintained" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.arm64-benchmarks.result }}" != "success" ]; then
            echo "âŒ ARM64 benchmarks failed or were skipped" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… ARM64 benchmarks completed successfully" >> $GITHUB_STEP_SUMMARY
          fi
