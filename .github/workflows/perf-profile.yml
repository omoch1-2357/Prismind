name: Perf Profiling (Linux)

# Task 10.2: Performance profiling with perf tools
# Measures cache miss rate and branch prediction miss rate on Linux (x86_64 and ARM64)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  # Allow manual trigger
  workflow_dispatch:
  # Run weekly to track performance trends
  schedule:
    - cron: '0 0 * * 0' # Every Sunday at midnight UTC

permissions:
  contents: read
  pull-requests: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # x86_64 Linux profiling
  perf-profile-x86-64:
    name: Perf Profile (x86_64 Linux)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo registry and build artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: perf-x86-64-cache

      - name: Install perf tools
        run: |
          sudo apt-get update
          export DEBIAN_FRONTEND=noninteractive

          echo "Kernel: $(uname -r)"

          # Azure kernel specific installation
          if sudo apt-get install -y "linux-tools-$(uname -r)" "linux-cloud-tools-$(uname -r)" linux-tools-common; then
             echo "Successfully installed specific kernel tools."
          else
             echo "Specific tools failed, trying generic/azure fallbacks..."
             # Fallback for Azure specifically if exact version match fails
             if [[ "$(uname -r)" == *"-azure"* ]]; then
                sudo apt-get install -y linux-tools-azure linux-cloud-tools-azure || true
             fi
             # Generic fallback
             sudo apt-get install -y linux-tools-generic || true
          fi

      - name: Verify perf installation
        run: |
          echo "Perf version:"
          perf --version || echo "perf not found"
          echo ""
          echo "Architecture:"
          uname -m
          echo ""
          echo "Kernel:"
          uname -r

      - name: Set perf permissions
        run: |
          # Allow perf to run without sudo for this session
          echo -1 | sudo tee /proc/sys/kernel/perf_event_paranoid
          echo 0 | sudo tee /proc/sys/kernel/kptr_restrict

      - name: Build benchmarks
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 20
          max_attempts: 3
          command: cargo build --release --benches

      - name: Run perf profiling (x86_64)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 30
          max_attempts: 3
          command: |
            # The script uses: perf stat -e cache-references,cache-misses,branches,branch-misses,instructions,cycles
            chmod +x scripts/perf_profile.sh
            ./scripts/perf_profile.sh 2>&1 | tee perf_x86_64.log

      - name: Extract performance metrics
        id: extract_metrics_x86
        run: |
          # Parse perf results
          if REPORT_FILE=$(compgen -G 'perf_results/perf_report_*.txt' | head -n1); then
            echo "Found report: $REPORT_FILE"

            # Extract cache miss rate
            CACHE_MISS_RATE=$(grep "Miss Rate:" "$REPORT_FILE" | head -1 | grep -oP '\d+\.\d+' || echo "N/A")
            echo "cache_miss_rate=$CACHE_MISS_RATE" >> "$GITHUB_OUTPUT"
            # Extract branch miss rate
            BRANCH_MISS_RATE=$(grep "Miss Rate:" "$REPORT_FILE" | tail -1 | grep -oP '\d+\.\d+' || echo "N/A")
            echo "branch_miss_rate=$BRANCH_MISS_RATE" >> "$GITHUB_OUTPUT"

            IPC=$(grep "IPC:" "$REPORT_FILE" | grep -oP '\d+\.\d+' || echo "N/A")
            echo "ipc=$IPC" >> "$GITHUB_OUTPUT"

            # Status checks
            CACHE_STATUS="UNKNOWN"
            BRANCH_STATUS="UNKNOWN"

            if [[ "$CACHE_MISS_RATE" != "N/A" ]]; then
              if (( $(echo "$CACHE_MISS_RATE <= 50" | bc -l) )); then
                CACHE_STATUS="PASS"
              else
                CACHE_STATUS="FAIL"
              fi
            fi
            echo "cache_status=$CACHE_STATUS" >> $GITHUB_OUTPUT

            if [[ "$BRANCH_MISS_RATE" != "N/A" ]]; then
              if (( $(echo "$BRANCH_MISS_RATE <= 1" | bc -l) )); then
                BRANCH_STATUS="PASS"
              else
                BRANCH_STATUS="FAIL"
              fi
            fi
            echo "branch_status=$BRANCH_STATUS" >> $GITHUB_OUTPUT

            echo "Extracted metrics:"
            echo "  Cache Miss Rate: $CACHE_MISS_RATE% ($CACHE_STATUS)"
            echo "  Branch Miss Rate: $BRANCH_MISS_RATE% ($BRANCH_STATUS)"
            echo "  IPC: $IPC"
          else
            echo "No report file found"
            echo "cache_miss_rate=N/A" >> "$GITHUB_OUTPUT"
            echo "branch_miss_rate=N/A" >> "$GITHUB_OUTPUT"
            echo "ipc=N/A" >> "$GITHUB_OUTPUT"
            echo "cache_status=ERROR" >> "$GITHUB_OUTPUT"
            echo "branch_status=ERROR" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload x86_64 perf results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: perf-results-x86-64
          path: |
            perf_results/
            perf_x86_64.log
          retention-days: 30

  # ARM64 Linux profiling
  perf-profile-arm64-linux:
    name: Perf Profile (ARM64 Linux)
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo registry and build artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: perf-arm64-linux-cache

      - name: Install perf tools
        run: |
          sudo apt-get update
          export DEBIAN_FRONTEND=noninteractive

          echo "Kernel: $(uname -r)"

          if sudo apt-get install -y "linux-tools-$(uname -r)" "linux-cloud-tools-$(uname -r)" linux-tools-common; then
             echo "Successfully installed specific kernel tools."
          else
             echo "Specific tools failed, trying fallbacks..."
             if [[ "$(uname -r)" == *"-azure"* ]]; then
                # Azure meta-package fallback
                sudo apt-get install -y linux-tools-azure linux-cloud-tools-azure || true
             fi
             # Generic fallback
             sudo apt-get install -y linux-tools-generic || true
          fi

      - name: Verify perf installation
        run: |
          echo "Perf version:"
          perf --version || echo "perf not found"
          echo ""
          echo "Architecture:"
          uname -m
          echo ""
          echo "Kernel:"
          uname -r

      - name: Set perf permissions
        run: |
          echo -1 | sudo tee /proc/sys/kernel/perf_event_paranoid
          echo 0 | sudo tee /proc/sys/kernel/kptr_restrict

      - name: Build benchmarks
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 20
          max_attempts: 3
          command: cargo build --release --benches

      - name: Run perf profiling (ARM64)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 30
          max_attempts: 3
          command: |
            chmod +x scripts/perf_profile.sh
            ./scripts/perf_profile.sh 2>&1 | tee perf_arm64.log

      - name: Extract performance metrics
        id: extract_metrics_arm
        run: |
          if REPORT_FILE=$(compgen -G 'perf_results/perf_report_*.txt' | head -n1); then
            echo "Found report: $REPORT_FILE"

            CACHE_MISS_RATE=$(grep "Miss Rate:" "$REPORT_FILE" | head -1 | grep -oP '\d+\.\d+' || echo "N/A")
            echo "cache_miss_rate=$CACHE_MISS_RATE" >> "$GITHUB_OUTPUT"

            BRANCH_MISS_RATE=$(grep "Miss Rate:" "$REPORT_FILE" | tail -1 | grep -oP '\d+\.\d+' || echo "N/A")
            echo "branch_miss_rate=$BRANCH_MISS_RATE" >> "$GITHUB_OUTPUT"

            IPC=$(grep "IPC:" "$REPORT_FILE" | grep -oP '\d+\.\d+' || echo "N/A")
            echo "ipc=$IPC" >> "$GITHUB_OUTPUT"

            CACHE_STATUS="UNKNOWN"
            BRANCH_STATUS="UNKNOWN"

            if [[ "$CACHE_MISS_RATE" != "N/A" ]]; then
              if (( $(echo "$CACHE_MISS_RATE <= 50" | bc -l) )); then
                CACHE_STATUS="PASS"
              else
                CACHE_STATUS="FAIL"
              fi
            fi
            echo "cache_status=$CACHE_STATUS" >> $GITHUB_OUTPUT

            if [[ "$BRANCH_MISS_RATE" != "N/A" ]]; then
              if (( $(echo "$BRANCH_MISS_RATE <= 1" | bc -l) )); then
                BRANCH_STATUS="PASS"
              else
                BRANCH_STATUS="FAIL"
              fi
            fi
            echo "branch_status=$BRANCH_STATUS" >> $GITHUB_OUTPUT

            echo "Extracted metrics:"
            echo "  Cache Miss Rate: $CACHE_MISS_RATE% ($CACHE_STATUS)"
            echo "  Branch Miss Rate: $BRANCH_MISS_RATE% ($BRANCH_STATUS)"
            echo "  IPC: $IPC"
          else
            echo "No report file found"
            echo "cache_miss_rate=N/A" >> "$GITHUB_OUTPUT"
            echo "branch_miss_rate=N/A" >> "$GITHUB_OUTPUT"
            echo "ipc=N/A" >> "$GITHUB_OUTPUT"
            echo "cache_status=ERROR" >> "$GITHUB_OUTPUT"
            echo "branch_status=ERROR" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload ARM64 perf results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: perf-results-arm64
          path: |
            perf_results/
            perf_arm64.log
          retention-days: 30

  # Generate comparison report
  generate-comparison-report:
    name: Generate Performance Comparison Report
    runs-on: ubuntu-latest
    needs: [perf-profile-x86-64, perf-profile-arm64-linux]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download x86_64 results
        uses: actions/download-artifact@v5
        with:
          name: perf-results-x86-64
          path: perf-x86-64/
        continue-on-error: true

      - name: Download ARM64 results
        uses: actions/download-artifact@v5
        with:
          name: perf-results-arm64
          path: perf-arm64/
        continue-on-error: true

      - name: Generate comparison report
        run: |
          # Create performance comparison report
          cat > performance_comparison.md << 'EOF'
          # Performance Comparison Report: x86_64 vs ARM64

          ## Task 10.2: Perf Profiling Results

          ### Performance Targets
          - **Cache Miss Rate**: ≤50%
          - **Branch Prediction Miss Rate**: ≤1%

          ---

          ## x86_64 Linux Results

          EOF

          X86_REPORT=$(find perf-x86-64/perf_results -name "perf_report_*.txt" | head -n1)

          # Append x86_64 results if available
          if [[ -f "$X86_REPORT" ]]; then
            echo "### Analysis Output" >> performance_comparison.md
            echo '```' >> performance_comparison.md
            cat "$X86_REPORT" >> performance_comparison.md
            echo '```' >> performance_comparison.md
          elif [[ -f perf-x86-64/perf_x86_64.log ]]; then
            echo "### Raw Perf Log" >> performance_comparison.md
            echo '```' >> performance_comparison.md
            grep -A 20 "Performance counter stats" perf-x86-64/perf_x86_64.log >> performance_comparison.md || echo "Log data not found" >> performance_comparison.md
            echo '```' >> performance_comparison.md
          else
            echo "*x86_64 results not available*" >> performance_comparison.md
          fi

          # ARM64 section
          cat >> performance_comparison.md << 'EOF'
          ---

          ## ARM64 Linux Results

          *Note: ARM64 Linux runners are available on GitHub Pro/Team/Enterprise with larger runners enabled*

          EOF

          ARM_REPORT=$(find perf-arm64/perf_results -name "perf_report_*.txt" | head -n1)

          if [[ -f "$ARM_REPORT" ]]; then
            echo "### Analysis Output" >> performance_comparison.md
            echo '```' >> performance_comparison.md
            cat "$ARM_REPORT" >> performance_comparison.md
            echo '```' >> performance_comparison.md
            echo "" >> performance_comparison.md
          elif [[ -f perf-arm64/perf_arm64.log ]]; then
            echo "### Raw Perf Log" >> performance_comparison.md
            echo '```' >> performance_comparison.md
            grep -A 20 "Performance counter stats" perf-arm64/perf_arm64.log >> performance_comparison.md || echo "Log data not found" >> performance_comparison.md
            echo '```' >> performance_comparison.md
          else
            echo "*ARM64 results not available*" >> performance_comparison.md
          fi

          # Footer
          cat >> performance_comparison.md << 'EOF'
          ---

          ## Recommendations

          ### For complete ARM64 Linux perf profiling:
          1. Enable GitHub-hosted ARM64 Linux runners (requires GitHub Pro/Team/Enterprise with Larger Runners)
          2. Or use a self-hosted ARM64 Linux runner (e.g., OCI Ampere A1, AWS Graviton)
          3. Or run manually: `./scripts/perf_profile.sh` on any ARM64 Linux machine

          ### Links
          - [Perf profiling documentation](docs/perf_profiling.md)
          - [Performance report template](docs/perf_report_template.md)

          EOF

          cat performance_comparison.md

      - name: Upload comparison report
        uses: actions/upload-artifact@v5
        with:
          name: performance-comparison-report
          path: performance_comparison.md
          retention-days: 90

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');

            let reportContent = '';
            try {
              reportContent = fs.readFileSync('performance_comparison.md', 'utf8');
            } catch (err) {
              reportContent = '## Performance Comparison Report\n\n*Report generation failed*\n\nCheck workflow logs for details.';
            }

            const commentBody = `## Perf Profiling Results (Task 10.2)\n\n${reportContent}\n\n**Download detailed results:** [View Artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComments = comments.filter(comment =>
              comment.user.login === 'github-actions[bot]' &&
              comment.body.includes('Perf Profiling Results (Task 10.2)')
            );

            if (botComments.length > 0) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComments[0].id,
                body: commentBody
              });

              // Delete duplicates
              for (let i = 1; i < botComments.length; i++) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComments[i].id
                });
              }
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }
